---
title: "FCBMA: factor collapsing with Bayesian model averaging for regression models"
author: "Sen Hu"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{FCBMA-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The `FCBMA` package uses factor collapsing (FC) and Bayesian model averaging (BMA) to find the optimal manners of combinations of categorical levels within categorical variables (i.e. clulstering of categorical levels) in linear or generalized linear regression models, as introduced in Hu et al (2018)

# Installation

You can install the latest development version of `FCBMA` from [GitHub](https://github.com/senhu/FCBMA): 
``` {r eval = FALSE}
install.packages("devtools")
devtools::install_github("senhu/FCBMA")
```
Then the package can be loaded with:
``` {r eval = TRUE}
library(FCBMA)
```

# Example

This vignette follows the example demonstrated in Hu et al (2018), using the Swedish third party motor insurance claims data in 1977 (available in this package). 
The data can be loaded via
```{r eval = TRUE}
data("sweden")
```
Details about the data set can be found in the data set documentation within this package. 

We start with the frequency aspect of claim modelling, by building a baseline frequency model based on which the categorical variables (factors) will be collapsed:
``` {r eval = TRUE}
freq <- glm(Claims ~ Zone + Bonus + Make + Kilometres, offset = log(Insured), 
            data = sweden, family = "poisson")
# summary(freq)
```
The model summary shows that all main effects are significant, but some levels within the rating factor Make are not statistically significant and henvce, clustering these levels seems natrual in the next step. 
We first use multiple comparison to compare the equivalence of means for the factor Make, employing the `multcomp` R package. 
``` {r eval = TRUE, message = FALSE, warning = FALSE}
freq.make.mult <- multcomp::glht(freq, linfct = multcomp::mcp(Make = "Tukey"))
# summary(freq.make.mult)
```
Then by comparison, the factor Make is collpased individually via `FCBMA`, and the model summary shows the best 5 collapsed model:
``` {r eval = TRUE}
freq.make <- FCBMA(model = freq, varia.list = c("Make"),
                   method = "SA", verbose = FALSE)
# freq.make <- FCBMA(model = freq, varia.list = c("Make"),
#                    method = "SA", verbose = FALSE,
#                    control.SA = list(init.Temp = 10000,
#                                      stop.Temp = 1e-5,
#                                      coolingRate = 0.7,
#                                      Mtrial = 20))
summary(freq.make)
```
Through `FCBMA` the grouping is more granular and BMA takes care of the uncertainty surrounding the grouping of levels 2 and 5 within Make factor.
Similarly we can also collapse other factors such as Kilometers individually via
``` {r eval = TRUE}
freq.kilo <- FCBMA(freq, varia.list = c("Kilometres"),
                   method = "complete", verbose = FALSE)
summary(freq.kilo)
```
Note that, depending on the size of the potential model space to search for the opitmal combinations of collapsing, either greedy/complete search or stochastic search with simulated annealing or genetic algorithm can be used, by setting `method = "complete"`, `"SA"` or `"GA"`. 

Next the severity model is considered, and the baseline model is fitted as
``` {r eval = TRUE}
sev <- glm(perd ~ Zone + Make + Bonus + Kilometres, weights = Claims,
           data = sweden, family = Gamma(link="log"))
# summary(sev)
# anova(sev, test="Chisq")
```
The baseline model summary suggests that the factor Kilometres is not significant, although some levels within are significant or marginally significant; the factor Make also has levels 2 and 6 being not significant. 
We start collapsing factors individually, via
``` {r eval = TRUE}
sev.kilo <- FCBMA(model = sev, varia.list = c("Kilometres"),
                  method = "complete", verbose = FALSE)
summary(sev.kilo)
sev.make <- FCBMA(model = sev, varia.list = c("Make"),
                  method = "GA", verbose = FALSE)
summary(sev.make)
```
If collapsing all factors simultaneously, there are 845,768,090,076 potential models in total in the model space to search from, hence a stochastic search needs to be used.
``` {r eval = FALSE}
sev.all.sa <- FCBMA(sev, varia.list = c("Kilometres", "Zone", "Bonus", "Make"), method = "SA", verbose = FALSE)
summary(sev.all.sa)
```

## Reference

Hu, S., O'Hagan, A., and Murphy, T. B. (2018) Motor insurance claim modelling with factor collapsing and Bayesian model averaging. _Stat_, __7__: e180. doi: 10.1002/sta4.180.
